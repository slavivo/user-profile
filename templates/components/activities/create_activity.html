<!-- Create Activity Form -->
<div id="create-activity-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-medium text-gray-900">Create New Activity</h3>
            <button onclick="toggleCreateActivityModal()" class="text-gray-400 hover:text-gray-500">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- API Controls -->
        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
            <div class="flex items-center justify-between space-x-4">
                <div class="w-64">
                    <label for="activity-api-select" class="block text-sm font-medium text-gray-700 mb-2">AI Provider</label>
                    <select id="activity-api-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option value="gemini">Google Gemini</option>
                        <option value="openai">OpenAI</option>
                    </select>
                </div>
                <div class="w-64">
                    <label for="activity-model-select" class="block text-sm font-medium text-gray-700 mb-2">Model</label>
                    <select id="activity-model-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <!-- Models will be populated by JavaScript -->
                    </select>
                </div>
            </div>
        </div>

        <!-- Creation Mode Selector -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Creation Mode</label>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <button id="brief-mode-btn" onclick="switchMode('brief')" class="px-4 py-2 text-sm font-medium rounded-md bg-indigo-600 text-white">
                    Brief Description
                </button>
                <button id="full-mode-btn" onclick="switchMode('full')" class="px-4 py-2 text-sm font-medium rounded-md bg-gray-200 text-gray-700">
                    Full Description
                </button>
                <button id="competencies-mode-btn" onclick="switchMode('competencies')" class="px-4 py-2 text-sm font-medium rounded-md bg-gray-200 text-gray-700">
                    Select Competencies
                </button>
                <button id="learning-goals-mode-btn" onclick="switchMode('learning-goals')" class="px-4 py-2 text-sm font-medium rounded-md bg-gray-200 text-gray-700">
                    Define Learning Goals
                </button>
                <button id="taxonomy-mode-btn" onclick="switchMode('taxonomy')" class="px-4 py-2 text-sm font-medium rounded-md bg-gray-200 text-gray-700">
                    Set Taxonomy Levels
                </button>
                <button id="combined-mode-btn" onclick="switchMode('combined')" class="px-4 py-2 text-sm font-medium rounded-md bg-gray-200 text-gray-700">
                    Combined Options
                </button>
            </div>
        </div>

        <!-- Activity Name -->
        <div class="mb-4">
            <label for="activity-name" class="block text-sm font-medium text-gray-700 mb-2">Activity Name</label>
            <input type="text" id="activity-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Enter activity name">
        </div>

        <!-- Brief Description Mode -->
        <div id="brief-mode" class="mb-4">
            <label for="brief-description" class="block text-sm font-medium text-gray-700 mb-2">Brief Description</label>
            <textarea id="brief-description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Briefly describe what you want the activity to accomplish..."></textarea>
            <p class="mt-1 text-sm text-gray-500">AI will generate a detailed description and all other details based on this brief description.</p>
        </div>

        <!-- Full Description Mode -->
        <div id="full-mode" class="hidden mb-4">
            <label for="full-description" class="block text-sm font-medium text-gray-700 mb-2">Full Description</label>
            <textarea id="full-description" rows="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Provide a detailed description of the activity..."></textarea>
            <p class="mt-1 text-sm text-gray-500">AI will generate learning goals, taxonomy classification, and other metadata based on this description.</p>
        </div>

        <!-- Competencies Mode -->
        <div id="competencies-mode" class="hidden mb-4">
            <div class="mb-4">
                <label for="competencies-brief-description" class="block text-sm font-medium text-gray-700 mb-2">Brief Description</label>
                <textarea id="competencies-brief-description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Briefly describe what you want the activity to accomplish..."></textarea>
                <p class="mt-1 text-sm text-gray-500">This will help generate a more focused activity that develops your target competencies.</p>
            </div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Set Target Competency Levels</label>
            <div class="space-y-4">
                <div class="flex items-center space-x-4">
                    <label class="w-1/3">Problem Solving</label>
                    <input type="range" min="0" max="100" value="50" class="w-1/2" id="problem-solving-level">
                    <span class="w-16" id="problem-solving-value">50%</span>
                </div>
                <div class="flex items-center space-x-4">
                    <label class="w-1/3">Critical Thinking</label>
                    <input type="range" min="0" max="100" value="50" class="w-1/2" id="critical-thinking-level">
                    <span class="w-16" id="critical-thinking-value">50%</span>
                </div>
                <div class="flex items-center space-x-4">
                    <label class="w-1/3">Analysis</label>
                    <input type="range" min="0" max="100" value="50" class="w-1/2" id="analysis-level">
                    <span class="w-16" id="analysis-value">50%</span>
                </div>
                <div class="flex items-center space-x-4">
                    <label class="w-1/3">Technical</label>
                    <input type="range" min="0" max="100" value="50" class="w-1/2" id="technical-level">
                    <span class="w-16" id="technical-value">50%</span>
                </div>
                <div class="flex items-center space-x-4">
                    <label class="w-1/3">Communication</label>
                    <input type="range" min="0" max="100" value="50" class="w-1/2" id="communication-level">
                    <span class="w-16" id="communication-value">50%</span>
                </div>
                <div class="flex items-center space-x-4">
                    <label class="w-1/3">Collaboration</label>
                    <input type="range" min="0" max="100" value="50" class="w-1/2" id="collaboration-level">
                    <span class="w-16" id="collaboration-value">50%</span>
                </div>
            </div>
        </div>

        <!-- Learning Goals Mode -->
        <div id="learning-goals-mode" class="hidden mb-4">
            <div class="mb-4">
                <label for="learning-goals-brief-description" class="block text-sm font-medium text-gray-700 mb-2">Brief Description</label>
                <textarea id="learning-goals-brief-description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Briefly describe what you want the activity to accomplish..."></textarea>
                <p class="mt-1 text-sm text-gray-500">This will help generate a more focused activity that achieves your learning goals.</p>
            </div>
            
            <!-- Learning Goals Section -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Learning Goals</label>
                
                <!-- Add Custom Goal -->
                <div class="flex items-center space-x-2 mb-4">
                    <input type="text" id="new-regular-goal" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Enter a custom learning goal...">
                    <button onclick="addRegularGoal()" class="px-3 py-2 text-sm font-medium rounded-md bg-indigo-600 text-white hover:bg-indigo-700">Add</button>
                </div>

                <!-- Graph Goals Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select from Knowledge Graph</label>
                    <div class="max-h-60 overflow-y-auto border rounded-md p-4">
                        <div class="grid grid-cols-1 gap-1" id="graph-goals-list">
                            <!-- Graph goals will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Selected Goals List -->
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Selected Learning Goals</label>
                    <div id="selected-learning-goals" class="space-y-2">
                        <!-- All selected goals will appear here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Taxonomy Mode -->
        <div id="taxonomy-mode" class="hidden mb-4">
            <div class="mb-4">
                <label for="taxonomy-brief-description" class="block text-sm font-medium text-gray-700 mb-2">Brief Description</label>
                <textarea id="taxonomy-brief-description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Briefly describe what you want the activity to accomplish..."></textarea>
                <p class="mt-1 text-sm text-gray-500">This will help generate a more focused activity that targets specific cognitive levels.</p>
            </div>
            
            <div class="space-y-6">
                <!-- Processing Levels -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Processing Levels</label>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <label class="w-1/3">Retrieval</label>
                            <input type="range" min="0" max="100" value="50" class="w-1/2" id="retrieval-level">
                            <span class="w-16" id="retrieval-value">50%</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <label class="w-1/3">Comprehension</label>
                            <input type="range" min="0" max="100" value="50" class="w-1/2" id="comprehension-level">
                            <span class="w-16" id="comprehension-value">50%</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <label class="w-1/3">Analysis</label>
                            <input type="range" min="0" max="100" value="50" class="w-1/2" id="analysis-level">
                            <span class="w-16" id="analysis-value">50%</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <label class="w-1/3">Knowledge Utilization</label>
                            <input type="range" min="0" max="100" value="50" class="w-1/2" id="knowledge-utilization-level">
                            <span class="w-16" id="knowledge-utilization-value">50%</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <label class="w-1/3">Metacognition</label>
                            <input type="range" min="0" max="100" value="50" class="w-1/2" id="metacognition-level">
                            <span class="w-16" id="metacognition-value">50%</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <label class="w-1/3">Self-system Thinking</label>
                            <input type="range" min="0" max="100" value="50" class="w-1/2" id="self-system-thinking-level">
                            <span class="w-16" id="self-system-thinking-value">50%</span>
                        </div>
                    </div>
                </div>

                <!-- Knowledge Domains -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Knowledge Domains</label>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <label class="w-1/3">Information</label>
                            <input type="range" min="0" max="100" value="50" class="w-1/2" id="information-domain-level">
                            <span class="w-16" id="information-domain-value">50%</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <label class="w-1/3">Mental Procedures</label>
                            <input type="range" min="0" max="100" value="50" class="w-1/2" id="mental-procedures-level">
                            <span class="w-16" id="mental-procedures-value">50%</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <label class="w-1/3">Psychomotor Procedures</label>
                            <input type="range" min="0" max="100" value="50" class="w-1/2" id="psychomotor-procedures-level">
                            <span class="w-16" id="psychomotor-procedures-value">50%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Combined Mode -->
        <div id="combined-mode" class="hidden mb-4">
            <div class="space-y-4">
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="include-brief" class="rounded text-indigo-600 focus:ring-indigo-500" onchange="updateCombinedSections()">
                    <label for="include-brief" class="text-sm font-medium text-gray-700">Include Brief Description</label>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="include-full" class="rounded text-indigo-600 focus:ring-indigo-500" onchange="updateCombinedSections()">
                    <label for="include-full" class="text-sm font-medium text-gray-700">Include Full Description</label>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="include-competencies" class="rounded text-indigo-600 focus:ring-indigo-500" onchange="updateCombinedSections()">
                    <label for="include-competencies" class="text-sm font-medium text-gray-700">Include Competencies</label>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="include-learning-goals" class="rounded text-indigo-600 focus:ring-indigo-500" onchange="updateCombinedSections()">
                    <label for="include-learning-goals" class="text-sm font-medium text-gray-700">Include Learning Goals</label>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="include-taxonomy" class="rounded text-indigo-600 focus:ring-indigo-500" onchange="updateCombinedSections()">
                    <label for="include-taxonomy" class="text-sm font-medium text-gray-700">Include Taxonomy Levels</label>
                </div>
            </div>
            <div id="combined-sections" class="space-y-4">
                <!-- Selected sections will be shown here -->
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end space-x-3 mt-6">
            <button onclick="toggleCreateActivityModal()" class="px-4 py-2 text-sm font-medium rounded-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50">
                Cancel
            </button>
            <button onclick="generateActivity()" class="px-4 py-2 text-sm font-medium rounded-md border border-transparent bg-indigo-600 text-white hover:bg-indigo-700">
                Generate Activity
            </button>
        </div>

        <!-- Generation Progress -->
        <div id="generation-progress" class="hidden mt-4">
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex items-center">
                    <div class="mr-3">
                        <svg class="animate-spin h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-900">Generating Activity</h4>
                        <p class="text-sm text-gray-500" id="generation-status">Processing...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include shared configurations -->
<script src="/static/js/shared/configs.js"></script>
<script>
// Add this at the top of your script
let conceptsData = null;
let competenciesData = null;
let taxonomyData = null;

async function loadInitialData() {
    try {
        const [conceptsResponse, competenciesResponse, taxonomyResponse] = await Promise.all([
            fetch('/api/all_nodes'),
            fetch('/api/competencies'),
            fetch('/api/taxonomy')
        ]);

        const conceptsJson = await conceptsResponse.json();
        
        // Check if the response is an array or has a specific structure
        conceptsData = Array.isArray(conceptsJson) ? conceptsJson : conceptsJson.nodes || [];
        
        competenciesData = await competenciesResponse.json();
        taxonomyData = await taxonomyResponse.json();

        populateConceptsList();
        populateCompetenciesList();
        populateTaxonomyLists();
        populateGraphGoals();
    } catch (error) {
        console.error('Error loading initial data:', error);
    }
}

function populateConceptsList() {
    if (!conceptsData || !conceptsData.nodes) return;
    
    const conceptsList = document.getElementById('concepts-list');
    conceptsList.innerHTML = conceptsData.nodes.map((node, index) => `
        <div class="flex items-center space-x-2 p-2 rounded-md hover:bg-gray-50">
            <input type="checkbox" id="concept-${index}" value="${node.data.label}" 
                   class="rounded text-indigo-600 focus:ring-indigo-500"
                   onchange="toggleConcept(this)">
            <label for="concept-${index}" class="text-sm text-gray-700 cursor-pointer flex-grow">${node.data.label}</label>
        </div>
    `).join('');
}

function toggleConcept(checkbox) {
    const conceptLabel = checkbox.value;
    const selectedConcepts = document.getElementById('selected-concepts');
    
    if (checkbox.checked) {
        // Add concept if it doesn't exist
        if (!document.querySelector(`[data-concept="${conceptLabel}"]`)) {
            const conceptTag = document.createElement('div');
            conceptTag.className = 'inline-flex items-center bg-indigo-100 text-indigo-800 rounded-full px-3 py-1';
            conceptTag.dataset.concept = conceptLabel;
            conceptTag.innerHTML = `
                <span class="text-sm">${conceptLabel}</span>
                <button onclick="removeConcept('${conceptLabel}')" class="ml-2 text-indigo-600 hover:text-indigo-800">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;
            selectedConcepts.appendChild(conceptTag);
        }
    } else {
        // Remove concept
        removeConcept(conceptLabel);
    }
}

function removeConcept(conceptLabel) {
    const conceptElement = document.querySelector(`[data-concept="${conceptLabel}"]`);
    if (conceptElement) {
        conceptElement.remove();
        // Uncheck the checkbox
        const checkbox = document.querySelector(`input[value="${conceptLabel}"]`);
        if (checkbox) checkbox.checked = false;
    }
}

function toggleCreateActivityModal() {
    const modal = document.getElementById('create-activity-modal');
    modal.classList.toggle('hidden');
}

function populateModels() {
    const provider = document.getElementById('activity-api-select').value;
    const modelSelect = document.getElementById('activity-model-select');
    const models = modelConfigs[provider];
    
    modelSelect.innerHTML = models.map(model => 
        `<option value="${model.id}" ${model.default ? 'selected' : ''}>${model.name}</option>`
    ).join('');
}

function switchMode(mode) {
    // Hide all mode sections
    const modes = ['brief', 'full', 'competencies', 'learning-goals', 'taxonomy', 'combined'];
    modes.forEach(m => {
        document.getElementById(`${m}-mode`).classList.add('hidden');
        document.getElementById(`${m}-mode-btn`).classList.remove('bg-indigo-600', 'text-white');
        document.getElementById(`${m}-mode-btn`).classList.add('bg-gray-200', 'text-gray-700');
    });
    
    // Show selected mode
    document.getElementById(`${mode}-mode`).classList.remove('hidden');
    document.getElementById(`${mode}-mode-btn`).classList.remove('bg-gray-200', 'text-gray-700');
    document.getElementById(`${mode}-mode-btn`).classList.add('bg-indigo-600', 'text-white');
    
    // Special handling for combined mode
    if (mode === 'combined') {
        setupCombinedMode();
    }
}

function setupCombinedMode() {
    // Add event listeners to checkboxes
    const checkboxes = ['brief', 'full', 'competencies', 'learning-goals', 'taxonomy'];
    checkboxes.forEach(type => {
        const checkbox = document.getElementById(`include-${type}`);
        if (checkbox) {
            checkbox.addEventListener('change', () => updateCombinedSections());
        }
    });
}

function updateCombinedSections() {
    const combinedSections = document.getElementById('combined-sections');
    
    // Check if the element exists
    if (!combinedSections) {
        console.error('Could not find combined-sections element');
        return;
    }
    
    combinedSections.innerHTML = '';
    
    // Check each section and clone if selected
    if (document.getElementById('include-brief')?.checked) {
        const briefSection = document.createElement('div');
        briefSection.className = 'mb-4';
        briefSection.innerHTML = `
            <label for="combined-brief-description" class="block text-sm font-medium text-gray-700 mb-2">Brief Description</label>
            <textarea id="combined-brief-description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Briefly describe what you want the activity to accomplish..."></textarea>
        `;
        combinedSections.appendChild(briefSection);
    }
    
    if (document.getElementById('include-full')?.checked) {
        const fullSection = document.createElement('div');
        fullSection.className = 'mb-4';
        fullSection.innerHTML = `
            <label for="combined-full-description" class="block text-sm font-medium text-gray-700 mb-2">Full Description</label>
            <textarea id="combined-full-description" rows="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Provide a detailed description of the activity..."></textarea>
        `;
        combinedSections.appendChild(fullSection);
    }
    
    if (document.getElementById('include-learning-goals')?.checked) {
        const learningGoalsSection = document.createElement('div');
        learningGoalsSection.className = 'mb-4';
        learningGoalsSection.innerHTML = `
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Learning Goals</label>
                
                <!-- Add Custom Goal -->
                <div class="flex items-center space-x-2 mb-4">
                    <input type="text" id="combined-new-regular-goal" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Enter a custom learning goal...">
                    <button onclick="addCombinedRegularGoal()" class="px-3 py-2 text-sm font-medium rounded-md bg-indigo-600 text-white hover:bg-indigo-700">Add</button>
                </div>

                <!-- Graph Goals Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select from Knowledge Graph</label>
                    <div class="max-h-60 overflow-y-auto border rounded-md p-4">
                        <div class="grid grid-cols-1 gap-1" id="combined-graph-goals-list">
                            <!-- Graph goals will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Selected Goals List -->
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Selected Learning Goals</label>
                    <div id="combined-selected-learning-goals" class="space-y-2">
                        <!-- All selected goals will appear here -->
                    </div>
                </div>
            </div>
        `;
        combinedSections.appendChild(learningGoalsSection);
        
        // Populate graph goals for combined mode
        if (conceptsData && conceptsData.length > 0) {
            const combinedGraphGoalsList = document.getElementById('combined-graph-goals-list');
            if (combinedGraphGoalsList) {
                let htmlContent = '';
                conceptsData.forEach(node => {
                    const goals = node.data.learning_goals || [];
                    goals.forEach(goal => {
                        htmlContent += `
                            <div class="flex items-center space-x-2 p-1 rounded-md hover:bg-gray-50">
                                <input type="checkbox" id="combined-goal-${node.data.id}-${goal.name}" 
                                       value='${JSON.stringify({
                                           type: "graph",
                                           name: goal.name,
                                           learning_goal_id: goal.id,
                                           node_label: node.data.label
                                       })}'
                                       class="rounded text-indigo-600 focus:ring-indigo-500"
                                       onchange="toggleCombinedGraphGoal(this)">
                                <label for="combined-goal-${node.data.id}-${goal.name}" class="text-sm text-gray-700 cursor-pointer flex-grow">
                                    ${goal.name}
                                    <span class="text-xs text-gray-500">(${node.data.label})</span>
                                </label>
                            </div>
                        `;
                    });
                });
                combinedGraphGoalsList.innerHTML = htmlContent;
            }
        }
    }
    
    if (document.getElementById('include-competencies')?.checked) {
        const competenciesSection = document.createElement('div');
        competenciesSection.className = 'mb-4';
        competenciesSection.innerHTML = `
            <label class="block text-sm font-medium text-gray-700 mb-2">Set Target Competency Levels</label>
            <div class="space-y-4">
                <div class="flex items-center space-x-4">
                    <label class="w-1/3">Problem Solving</label>
                    <input type="range" min="0" max="100" value="50" class="w-1/2" id="combined-problem-solving-level" oninput="this.nextElementSibling.textContent = this.value + '%'">
                    <span class="w-16">50%</span>
                </div>
                <div class="flex items-center space-x-4">
                    <label class="w-1/3">Critical Thinking</label>
                    <input type="range" min="0" max="100" value="50" class="w-1/2" id="combined-critical-thinking-level" oninput="this.nextElementSibling.textContent = this.value + '%'">
                    <span class="w-16">50%</span>
                </div>
                <div class="flex items-center space-x-4">
                    <label class="w-1/3">Analysis</label>
                    <input type="range" min="0" max="100" value="50" class="w-1/2" id="combined-analysis-level" oninput="this.nextElementSibling.textContent = this.value + '%'">
                    <span class="w-16">50%</span>
                </div>
                <div class="flex items-center space-x-4">
                    <label class="w-1/3">Technical</label>
                    <input type="range" min="0" max="100" value="50" class="w-1/2" id="combined-technical-level" oninput="this.nextElementSibling.textContent = this.value + '%'">
                    <span class="w-16">50%</span>
                </div>
                <div class="flex items-center space-x-4">
                    <label class="w-1/3">Communication</label>
                    <input type="range" min="0" max="100" value="50" class="w-1/2" id="combined-communication-level" oninput="this.nextElementSibling.textContent = this.value + '%'">
                    <span class="w-16">50%</span>
                </div>
                <div class="flex items-center space-x-4">
                    <label class="w-1/3">Collaboration</label>
                    <input type="range" min="0" max="100" value="50" class="w-1/2" id="combined-collaboration-level" oninput="this.nextElementSibling.textContent = this.value + '%'">
                    <span class="w-16">50%</span>
                </div>
            </div>
        `;
        combinedSections.appendChild(competenciesSection);
    }
    
    if (document.getElementById('include-taxonomy')?.checked) {
        const taxonomySection = document.createElement('div');
        taxonomySection.className = 'mb-4';
        taxonomySection.innerHTML = `
            <div class="space-y-6">
                <!-- Processing Levels -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Processing Levels</label>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <label class="w-1/3">Retrieval</label>
                            <input type="range" min="0" max="100" value="50" class="w-1/2" id="combined-retrieval-level" oninput="this.nextElementSibling.textContent = this.value + '%'">
                            <span class="w-16">50%</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <label class="w-1/3">Comprehension</label>
                            <input type="range" min="0" max="100" value="50" class="w-1/2" id="combined-comprehension-level" oninput="this.nextElementSibling.textContent = this.value + '%'">
                            <span class="w-16">50%</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <label class="w-1/3">Analysis</label>
                            <input type="range" min="0" max="100" value="50" class="w-1/2" id="combined-analysis-level" oninput="this.nextElementSibling.textContent = this.value + '%'">
                            <span class="w-16">50%</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <label class="w-1/3">Knowledge Utilization</label>
                            <input type="range" min="0" max="100" value="50" class="w-1/2" id="combined-knowledge-utilization-level" oninput="this.nextElementSibling.textContent = this.value + '%'">
                            <span class="w-16">50%</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <label class="w-1/3">Metacognition</label>
                            <input type="range" min="0" max="100" value="50" class="w-1/2" id="combined-metacognition-level" oninput="this.nextElementSibling.textContent = this.value + '%'">
                            <span class="w-16">50%</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <label class="w-1/3">Self-system Thinking</label>
                            <input type="range" min="0" max="100" value="50" class="w-1/2" id="combined-self-system-thinking-level" oninput="this.nextElementSibling.textContent = this.value + '%'">
                            <span class="w-16">50%</span>
                        </div>
                    </div>
                </div>

                <!-- Knowledge Domains -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Knowledge Domains</label>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <label class="w-1/3">Information</label>
                            <input type="range" min="0" max="100" value="50" class="w-1/2" id="combined-information-domain-level" oninput="this.nextElementSibling.textContent = this.value + '%'">
                            <span class="w-16">50%</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <label class="w-1/3">Mental Procedures</label>
                            <input type="range" min="0" max="100" value="50" class="w-1/2" id="combined-mental-procedures-level" oninput="this.nextElementSibling.textContent = this.value + '%'">
                            <span class="w-16">50%</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <label class="w-1/3">Psychomotor Procedures</label>
                            <input type="range" min="0" max="100" value="50" class="w-1/2" id="combined-psychomotor-procedures-level" oninput="this.nextElementSibling.textContent = this.value + '%'">
                            <span class="w-16">50%</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        combinedSections.appendChild(taxonomySection);
    }
}

function toggleCombinedConcept(checkbox) {
    const conceptLabel = checkbox.value;
    const selectedConcepts = document.getElementById('combined-selected-concepts');
    
    if (checkbox.checked) {
        if (!document.querySelector(`[data-concept="${conceptLabel}"]`)) {
            const conceptTag = document.createElement('div');
            conceptTag.className = 'inline-flex items-center bg-indigo-100 text-indigo-800 rounded-full px-3 py-1';
            conceptTag.dataset.concept = conceptLabel;
            conceptTag.innerHTML = `
                <span class="text-sm">${conceptLabel}</span>
                <button onclick="removeCombinedConcept('${conceptLabel}')" class="ml-2 text-indigo-600 hover:text-indigo-800">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;
            selectedConcepts.appendChild(conceptTag);
        }
    } else {
        removeCombinedConcept(conceptLabel);
    }
}

function removeCombinedConcept(conceptLabel) {
    const conceptElement = document.querySelector(`[data-concept="${conceptLabel}"]`);
    if (conceptElement) {
        conceptElement.remove();
        const checkbox = document.querySelector(`input[value="${conceptLabel}"]`);
        if (checkbox) checkbox.checked = false;
    }
}

function toggleGraphGoal(checkbox) {
    const goalData = JSON.parse(checkbox.value);
    const selectedGoals = document.getElementById('selected-learning-goals');
    
    if (checkbox.checked) {
        if (!document.querySelector(`[data-goal-id="${goalData.node_id}-${goalData.name}"]`)) {
            const goalElement = document.createElement('div');
            goalElement.className = 'flex items-center justify-between p-1 bg-indigo-50 rounded-md';
            goalElement.dataset.goalId = `${goalData.node_id}-${goalData.name}`;
            goalElement.innerHTML = `
                <div class="flex items-center">
                    <span class="text-indigo-900">${goalData.name}</span>
                    <span class="ml-2 text-xs text-gray-500">(Graph: ${goalData.node_label})</span>
                </div>
                <button onclick="removeGoal('${goalData.node_id}-${goalData.name}')" class="text-indigo-600 hover:text-indigo-800">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;
            selectedGoals.appendChild(goalElement);
        }
    } else {
        removeGoal(`${goalData.node_id}-${goalData.name}`);
    }
}

function addRegularGoal() {
    const input = document.getElementById('new-regular-goal');
    const goal = input.value.trim();
    
    if (goal) {
        const goalsContainer = document.getElementById('selected-learning-goals');
        const goalElement = document.createElement('div');
        goalElement.className = 'flex items-center justify-between p-1 bg-indigo-50 rounded-md';
        goalElement.dataset.goalId = `custom-${goal}`;
        goalElement.innerHTML = `
            <div class="flex items-center">
                <span class="text-indigo-900">${goal}</span>
                <span class="ml-2 text-xs text-gray-500">(Custom)</span>
            </div>
            <button onclick="removeGoal('custom-${goal}')" class="text-indigo-600 hover:text-indigo-800">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        `;
        goalsContainer.appendChild(goalElement);
        input.value = '';
    }
}

function removeGoal(goalId) {
    const goalElement = document.querySelector(`[data-goal-id="${goalId}"]`);
    if (goalElement) {
        goalElement.remove();
        // If it's a graph goal, uncheck the checkbox
        if (!goalId.startsWith('custom-')) {
            const checkbox = document.querySelector(`input[value*="${goalId}"]`);
            if (checkbox) checkbox.checked = false;
        }
    }
}

function getAllLearningGoals() {
    const goals = [];
    document.querySelectorAll('#selected-learning-goals > div').forEach(div => {
        const goalId = div.dataset.goalId;
        if (goalId.startsWith('custom-')) {
            goals.push({
                type: 'regular',
                name: div.querySelector('span.text-indigo-900').textContent
            });
        } else {
            const checkbox = document.querySelector(`input[value*="${goalId}"]`);
            if (checkbox) {
                goals.push(JSON.parse(checkbox.value));
            }
        }
    });
    return goals;
}

function toggleCombinedGraphGoal(checkbox) {
    const goalData = JSON.parse(checkbox.value);
    const selectedGoals = document.getElementById('combined-selected-learning-goals');
    
    if (checkbox.checked) {
        if (!document.querySelector(`[data-goal-id="combined-${goalData.node_id}-${goalData.name}"]`)) {
            const goalElement = document.createElement('div');
            goalElement.className = 'flex items-center justify-between p-1 bg-indigo-50 rounded-md';
            goalElement.dataset.goalId = `combined-${goalData.node_id}-${goalData.name}`;
            goalElement.innerHTML = `
                <div class="flex items-center">
                    <span class="text-indigo-900">${goalData.name}</span>
                    <span class="ml-2 text-xs text-gray-500">(Graph: ${goalData.node_label})</span>
                </div>
                <button onclick="removeCombinedGoal('${goalData.node_id}-${goalData.name}')" class="text-indigo-600 hover:text-indigo-800">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;
            selectedGoals.appendChild(goalElement);
        }
    } else {
        removeCombinedGoal(`${goalData.node_id}-${goalData.name}`);
    }
}

function addCombinedRegularGoal() {
    const input = document.getElementById('combined-new-regular-goal');
    const goal = input.value.trim();
    
    if (goal) {
        const goalsContainer = document.getElementById('combined-selected-learning-goals');
        const goalElement = document.createElement('div');
        goalElement.className = 'flex items-center justify-between p-1 bg-indigo-50 rounded-md';
        goalElement.dataset.goalId = `combined-custom-${goal}`;
        goalElement.innerHTML = `
            <div class="flex items-center">
                <span class="text-indigo-900">${goal}</span>
                <span class="ml-2 text-xs text-gray-500">(Custom)</span>
            </div>
            <button onclick="removeCombinedGoal('custom-${goal}')" class="text-indigo-600 hover:text-indigo-800">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        `;
        goalsContainer.appendChild(goalElement);
        input.value = '';
    }
}

function removeCombinedGoal(goalId) {
    const goalElement = document.querySelector(`[data-goal-id="combined-${goalId}"]`);
    if (goalElement) {
        goalElement.remove();
        // If it's a graph goal, uncheck the checkbox
        if (!goalId.startsWith('custom-')) {
            const checkbox = document.querySelector(`input[value*="${goalId}"]`);
            if (checkbox) checkbox.checked = false;
        }
    }
}

function populateCompetenciesList() {
    if (!competenciesData) return;

    // Update both regular and combined mode competencies sections
    const sections = ['', 'combined-'];
    sections.forEach(prefix => {
        const container = document.querySelector(`#${prefix}competencies-mode .space-y-4`);
        if (container) {
            container.innerHTML = competenciesData.map(comp => `
                <div class="flex items-center space-x-4">
                    <label class="w-1/3">${comp.name}</label>
                    <input type="range" min="0" max="100" value="50" 
                           class="w-1/2" 
                           id="${prefix}${comp.id}-level"
                           oninput="this.nextElementSibling.textContent = this.value + '%'">
                    <span class="w-16">50%</span>
                </div>
            `).join('');
        }
    });
}

function populateTaxonomyLists() {
    if (!taxonomyData) return;

    // Update both regular and combined mode taxonomy sections
    const sections = ['', 'combined-'];
    sections.forEach(prefix => {
        // Populate Processing Levels
        const processingContainer = document.querySelector(`#${prefix}taxonomy-mode .space-y-6 > div:first-child .space-y-4`);
        if (processingContainer) {
            processingContainer.innerHTML = taxonomyData.processing_levels.map(level => `
                <div class="flex items-center space-x-4">
                    <label class="w-1/3">${level.name}</label>
                    <input type="range" min="0" max="100" value="50" 
                           class="w-1/2" 
                           id="${prefix}${level.id}-level"
                           oninput="this.nextElementSibling.textContent = this.value + '%'">
                    <span class="w-16">50%</span>
                </div>
            `).join('');
        }

        // Populate Knowledge Domains
        const domainContainer = document.querySelector(`#${prefix}taxonomy-mode .space-y-6 > div:last-child .space-y-4`);
        if (domainContainer) {
            domainContainer.innerHTML = taxonomyData.domain_of_knowledge.map(domain => `
                <div class="flex items-center space-x-4">
                    <label class="w-1/3">${domain.name}</label>
                    <input type="range" min="0" max="100" value="50" 
                           class="w-1/2" 
                           id="${prefix}${domain.id}-level"
                           oninput="this.nextElementSibling.textContent = this.value + '%'">
                    <span class="w-16">50%</span>
                </div>
            `).join('');
        }
    });
}

function populateGraphGoals() {
    if (!conceptsData || conceptsData.length === 0) {
        console.log('No concepts data available');
        return;
    }
    
    const graphGoalsList = document.getElementById('graph-goals-list');
    if (!graphGoalsList) {
        console.log('Graph goals list element not found');
        return;
    }

    let htmlContent = '';
    conceptsData.forEach(node => {
        const goals = node.data.learning_goals || [];
        goals.forEach(goal => {
            htmlContent += `
                <div class="flex items-center space-x-2 p-1 rounded-md hover:bg-gray-50">
                    <input type="checkbox" id="goal-${node.data.id}-${goal.name}" 
                           value='${JSON.stringify({
                               type: "graph",
                               name: goal.name,
                               node_id: node.data.id,
                               node_label: node.data.label
                           })}'
                           class="rounded text-indigo-600 focus:ring-indigo-500"
                           onchange="toggleGraphGoal(this)">
                    <label for="goal-${node.data.id}-${goal.name}" class="text-sm text-gray-700 cursor-pointer flex-grow">
                        ${goal.name}
                        <span class="text-xs text-gray-500">(${node.data.label})</span>
                    </label>
                </div>
            `;
        });
    });
    
    graphGoalsList.innerHTML = htmlContent;
}

function getCompetencyLevels() {
    if (!competenciesData) return {};
    
    const levels = {};
    competenciesData.forEach(comp => {
        levels[comp.id] = parseInt(document.getElementById(`${comp.id}-level`).value);
    });
    return levels;
}

function getSelectedConcepts() {
    const concepts = [];
    document.querySelectorAll('#selected-concepts > div > span').forEach(span => {
        concepts.push(span.textContent);
    });
    return concepts;
}

function getTaxonomyLevels() {
    if (!taxonomyData) return {};

    return {
        processing_levels: taxonomyData.processing_levels.reduce((acc, level) => {
            acc[level.id] = parseInt(document.getElementById(`${level.id}-level`).value);
            return acc;
        }, {}),
        knowledge_domains: taxonomyData.domain_of_knowledge.reduce((acc, domain) => {
            acc[domain.id] = parseInt(document.getElementById(`${domain.id}-level`).value);
            return acc;
        }, {})
    };
}

function getCombinedTaxonomyLevels() {
    if (!taxonomyData) return {};

    return {
        processing_levels: taxonomyData.processing_levels.reduce((acc, level) => {
            acc[level.id] = parseInt(document.getElementById(`combined-${level.id}-level`).value);
            return acc;
        }, {}),
        knowledge_domains: taxonomyData.domain_of_knowledge.reduce((acc, domain) => {
            acc[domain.id] = parseInt(document.getElementById(`combined-${domain.id}-level`).value);
            return acc;
        }, {})
    };
}

// Add event listener for Enter key in regular goals input
document.getElementById('new-regular-goal')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        addRegularGoal();
    }
});

// Add event listener for Enter key in combined regular goals input
document.getElementById('combined-new-regular-goal')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        addCombinedRegularGoal();
    }
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    populateModels();
    document.getElementById('activity-api-select').addEventListener('change', populateModels);
    
    // Load all initial data
    loadInitialData();
});

async function generateActivity() {
    // Show progress indicator
    const progress = document.getElementById('generation-progress');
    const status = document.getElementById('generation-status');
    progress.classList.remove('hidden');
    
    // Get form data
    const provider = document.getElementById('activity-api-select').value;
    const model = document.getElementById('activity-model-select').value;
    const name = document.getElementById('activity-name').value;
    
    // Get data based on active mode
    let requestData = {
        provider,
        model,
        name,
        mode: 'combined',
        brief_description: null,
        full_description: null,
        concepts: null,
        competencies: null,
        learning_goals: null,
        taxonomy: null
    };

    // In combined mode, gather data from all visible sections
    const combinedMode = !document.getElementById('combined-mode').classList.contains('hidden');
    
    if (combinedMode) {
        // Handle combined mode parameters
        if (document.getElementById('include-brief').checked) {
            requestData.brief_description = document.getElementById('combined-brief-description')?.value;
            console.log('Brief description:', requestData.brief_description);
        }
        
        if (document.getElementById('include-full').checked) {
            requestData.full_description = document.getElementById('combined-full-description')?.value;
            console.log('Full description:', requestData.full_description);
        }
        
        if (document.getElementById('include-concepts').checked) {
            // Get concepts from the combined-selected-concepts container
            const concepts = [];
            document.querySelectorAll('#combined-selected-concepts > div > span').forEach(span => {
                concepts.push(span.textContent);
            });
            requestData.concepts = concepts;
            console.log('Concepts:', requestData.concepts);
        }
        
        if (document.getElementById('include-competencies').checked) {
            // Get competencies from the combined competencies sliders
            requestData.competencies = {
                problem_solving: parseInt(document.getElementById('combined-problem-solving-level').value),
                critical_thinking: parseInt(document.getElementById('combined-critical-thinking-level').value),
                analysis: parseInt(document.getElementById('combined-analysis-level').value),
                technical: parseInt(document.getElementById('combined-technical-level').value),
                communication: parseInt(document.getElementById('combined-communication-level').value),
                collaboration: parseInt(document.getElementById('combined-collaboration-level').value)
            };
            console.log('Competencies:', requestData.competencies);
        }
        
        if (document.getElementById('include-learning-goals').checked) {
            // Get learning goals from the combined-selected-learning-goals container
            requestData.learning_goals = getAllLearningGoals();
            console.log('Learning goals:', requestData.learning_goals);
        }
        
        if (document.getElementById('include-taxonomy').checked) {
            // Get taxonomy values from the combined taxonomy sliders
            requestData.taxonomy = getCombinedTaxonomyLevels();
        }
    } else {
        // Single mode handling remains unchanged
        if (!document.getElementById('brief-mode').classList.contains('hidden')) {
            requestData.mode = 'brief';
            requestData.brief_description = document.getElementById('brief-description').value;
        } else if (!document.getElementById('full-mode').classList.contains('hidden')) {
            requestData.mode = 'full';
            requestData.full_description = document.getElementById('full-description').value;
        } else if (!document.getElementById('concepts-mode').classList.contains('hidden')) {
            requestData.mode = 'concepts';
            requestData.brief_description = document.getElementById('concepts-brief-description').value;
            requestData.concepts = getSelectedConcepts();
        } else if (!document.getElementById('competencies-mode').classList.contains('hidden')) {
            requestData.mode = 'competencies';
            requestData.brief_description = document.getElementById('competencies-brief-description').value;
            requestData.competencies = getCompetencyLevels();
        } else if (!document.getElementById('learning-goals-mode').classList.contains('hidden')) {
            requestData.mode = 'learning-goals';
            requestData.brief_description = document.getElementById('learning-goals-brief-description').value;
            requestData.learning_goals = getAllLearningGoals();
        } else if (!document.getElementById('taxonomy-mode').classList.contains('hidden')) {
            requestData.mode = 'taxonomy';
            requestData.brief_description = document.getElementById('taxonomy-brief-description').value;
            requestData.taxonomy = getTaxonomyLevels();
        }
    }
    
    try {
        status.textContent = 'Sending request...';
        
        const response = await fetch('/generate_activity', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        
        if (result.error) {
            throw new Error(result.error);
        }

        // Hide modal and show success message
        toggleCreateActivityModal();
        
        // Refresh only the activities section
        const activitiesSection = document.getElementById('activities-section');
        if (activitiesSection) {
            const activitiesResponse = await fetch('/activities_content');
            const activitiesHtml = await activitiesResponse.text();
            activitiesSection.innerHTML = activitiesHtml;
        }

    } catch (error) {
        status.textContent = `Error: ${error.message}`;
        console.error('Error:', error);
    }
}
</script> 